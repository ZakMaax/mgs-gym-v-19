<?xml version="1.0" encoding="utf-8"?>
<odoo>
      <!-- Report definition -->
  <template id="mgs_sale_detailed_report">
    <t t-call="web.html_container">
    <t t-call="web.external_layout">
      <t t-set="report_data" t-value="docs[0].get_detailed_sales_data()"/>
      <div class="page">
        <!-- Title -->
        <h2 class="report-title">Detailed <t t-esc="docs[0].group_by.title()"/> Sales Report</h2>
        <p class="report-subtitle fw-bold">
          From (<t t-esc="docs[0].date_from"/>) - To (<t t-esc="docs[0].date_to"/>)
        </p>

        <!-- Table wrapper -->
      <table class="table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="font-weight:bold; white-space:nowrap;">
            <th style="width:12%; padding:6px 10px;">Order Date</th>
            <th style="width:10%; padding:6px 10px;">Order ID</th>
            <t t-if="docs[0].group_by == 'customer'">
              <th style="width:28%; padding:6px 10px;">Item</th>
            </t>
            <t t-if="docs[0].group_by == 'item'">
              <th style="width:28%; padding:6px 10px;">Customer</th>
            </t>
            <th style="width:8%; padding:6px 10px; text-align:right;">Ordered Qty</th>
            <th style="width:8%; padding:6px 10px; text-align:right;">Delivered Qty</th>
            <th style="width:8%; padding:6px 10px; text-align:right;">Invoiced Qty</th>
            <th style="width:8%; padding:6px 10px; text-align:right;">Rate</th>
            <th style="width:12%; padding:6px 10px; text-align:right;">Amount</th>
            <t t-if="user.has_group('account.group_account_manager')">
                <th style="width:8%; padding:6px 10px; text-align:right;">Cost</th>
                <th style="width:8%; padding:6px 10px; text-align:right;">Margin</th>
            </t>

          </tr>
        </thead>
        <tbody>
          <t t-if="report_data">
            <t t-foreach="report_data" t-as="section">
              <!-- Group Header -->
              <tr style="background-color:#0d6efd; color: white; font-weight:bold;">
                <td colspan="11" style="padding:6px 10px; color: white; white-space:nowrap; text-transform: uppercase;">
                  <t t-esc="docs[0].group_by == 'customer' and 'Customer' or 'Item'"/>: 
                  <span t-esc="section.get('group')"/>
                </td>
              </tr>

              <!-- Lines -->
              <t t-foreach="section['orders']" t-as="line">
                <tr>
                  <td style="padding:6px 10px; white-space:nowrap;"><t t-esc="line['order_date'].strftime('%Y-%m-%d')"/></td>
                  <td style="padding:6px 10px; white-space:nowrap;"><t t-esc="line['order_name']"/></td>
                  <t t-if="docs[0].group_by == 'customer'">
                    <td style="padding:6px 10px; white-space:nowrap;"><t t-esc="line['product']"/></td>
                  </t>
                  <t t-if="docs[0].group_by == 'item'">
                    <td style="padding:6px 10px; white-space:nowrap;"><t t-esc="line['customer']"/></td>
                  </t>
                  <td style="text-align:right; padding:6px 10px;" ><t t-esc="'{0:,.2f}'.format(line['ordered_qty'])"/></td>
                  <td style="text-align:right; padding:6px 10px;" ><t t-esc="'{0:,.2f}'.format(line['delivered_qty'])"/></td>
                  <td style="text-align:right; padding:6px 10px;" ><t t-esc="'{0:,.2f}'.format(line['invoiced_qty'])"/></td>
                  <td style="text-align:right; padding:6px 10px;" ><t t-esc="'{0:,.2f}'.format(line['rate'])"/></td>
                  <td style="text-align:right; padding:6px 10px;" ><t t-esc="'{0:,.2f}'.format(line['amount'])"/></td>
                  <t t-if="user.has_group('account.group_account_manager')">
                    <td style="text-align:right; padding:6px 10px;" ><t t-esc="'{0:,.2f}'.format(line['cost'])"/></td>
                    <td style="text-align:right; padding:6px 10px;" ><t t-esc="'{0:,.2f}'.format(line['margin'])"/></td>
                  </t>
                </tr>
              </t>

              <!-- Group totals -->
              <tr style="font-weight:bold; text-align:right; background-color:#fd7e14;">
                <td colspan="3" style="padding:6px 10px; white-space:nowrap; text-align:right; color:black;">Group Total</td>
                <td style="text-align:right; padding:6px 10px; color:black;" ><t t-esc="'{0:,.2f}'.format(section.get('total_ordered_qty'))"/></td>
                <td style="text-align:right; padding:6px 10px; color:black;" ><t t-esc="'{0:,.2f}'.format(section.get('total_delivered_qty'))"/></td>
                               <td style="text-align:right; padding:6px 10px; color:black;" ><t t-esc="'{0:,.2f}'.format(section.get('total_invoiced_qty'))"/></td>
                <td></td>
                <td style="text-align:right; padding:6px 10px; color:black;" ><t t-esc="'{0:,.2f}'.format(section.get('total_amount'))"/></td>
                <t t-if="user.has_group('account.group_account_manager')">
                  <td></td>
                  <td></td>
                </t>
              </tr>
            </t>

            <!-- Grand totals -->
            <tr style="font-weight:bold; text-align:right; border-top:5px solid black; background-color:#dc3545">
              <td colspan="3" style="padding:6px 10px; white-space:nowrap; text-align:right; color:white">Grand Total</td>
              <td style="text-align:right; padding:6px 10px; color: white;" >
                <t t-esc="'{0:,.2f}'.format(sum([s.get('total_ordered_qty',0) for s in report_data]))"/>
              </td>
              <td style="text-align:right; padding:6px 10px; color: white;" >
                <t t-esc="'{0:,.2f}'.format(sum([s.get('total_delivered_qty',0) for s in report_data]))"/>
              </td>
              <td style="text-align:right; padding:6px 10px; color: white;" >
                <t t-esc="'{0:,.2f}'.format(sum([s.get('total_invoiced_qty',0) for s in report_data]))"/>
              </td>
              <td></td>
              <td style="text-align:right; padding:6px 10px; color: white;" >
                <t t-esc="'{0:,.2f}'.format(sum([s.get('total_amount',0) for s in report_data]))"/>
              </td>
              <t t-if="user.has_group('account.group_account_manager')">
                  <td></td>
                  <td></td>
              </t>
            </tr>
          </t>

          <!-- No data message -->
          <t t-if="not report_data">
            <tr>
              <td colspan="11" style="text-align:center; padding:18px; color:#666; white-space:nowrap;">
                No data available for the selected filters and grouping.
              </td>
            </tr>
          </t>
      </tbody>
      </table>


        <!-- Footer note -->
        <div style="margin-top:12px; font-size:11px; color:#666;">
          Report generated by <t t-esc="docs[0].env.user.name"/> on <t t-esc="time.strftime('%Y-%m-%d %H:%M')"/>
        </div>
      </div>
    </t>
    </t>
  </template>

</odoo>